#!/bin/bash

export codename=el8
export arch=amd64
export pkgType=rpm
export now=$(date -u +%Y%m%d-%H%M)

echo "wait 180"
sleep 180
echo "done waiting"

sudo yum update

sleep 10

# Enable PowerTool packages
sudo dnf -y install dnf-plugins-core
sudo dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
sudo dnf config-manager --set-enabled PowerTools

echo "Installing HPCC build prerequisites"

sudo yum install -y \
                 epel-release          \
                 wget                  \
                 unzip                 \
                 git                   \
                 gcc                   \
                 gcc-c++               \
                 automake              \
                 m4                    \
                 make                  \
                 bison                 \
                 flex                  \
                 binutils-devel        \
                 openldap-devel        \
                 libicu-devel          \
                 libxslt-devel         \
                 libarchive-devel      \
                 boost-devel           \
                 openssl-devel         \
                 apr-devel             \
                 apr-util-devel

sudo yum install -y \
                 hiredis-devel         \
                 numactl-devel         \
                 libevent-devel        \
                 java-latest-openjdk-devel \
                 sqlite-devel          \
                 tbb-devel             \
                 libmemcached-devel    \
                 rpm-build             \
                 curl-devel            \
                 gtk2-devel            \
                 freetype-devel        \
                 zip                   \
                 libtool               \
                 libbsd-devel          \
                 mysql-devel

#V8=v8-6.7.17-8.el8.x86_64.rpm 
#V8_DEVEL=v8-devel-6.7.17-8.el8.x86_64.rpm
#wget http://repo.okay.com.mx/centos/8/x86_64/release/${V8}
#wget http://repo.okay.com.mx/centos/8/x86_64/release/${V8_DEVEL}
#sudo yum install -y ${V8} ${V8_DEVEL}
#rm -rf ${V8} ${V8_DEVEL}

sudo yum install -y python2-devel
sudo yum module install -y python36/build
sudo alternatives --set python /usr/bin/python3
sudo yum install -y python3-pip
sudo pip3 install --upgrade pip3

sudo yum module install -y nodejs/development
sudo yum install -y mysql-devel

# R 
sudo yum install -y R-core R-core-devel
RCPP=Rcpp_1.0.3.tar.gz
wget https://cran.r-project.org/src/contrib/00Archive/Rcpp/${RCPP}
sudo R CMD INSTALL ${RCPP}
rm -rf ${RCPP}
RINSIDE=RInside_0.2.15.tar.gz
wget https://cran.r-project.org/src/contrib/00Archive/RInside/${RINSIDE}
sudo R CMD INSTALL ${RINSIDE}
rm -rf ${RINSIDE}

echo "Maven"
MAVEN=apache-maven-3.6.3
wget http://apache.mirrors.hoobly.com/maven/maven-3/3.6.3/binaries/${MAVEN}-bin.tar.gz
sudo tar -zxvf ${MAVEN}-bin.tar.gz -C /usr/local
sudo ln -s /usr/local/${MAVEN} /usr/local/maven
sudo sh -c 'echo "export MAVEN_HOME=/usr/local/maven" >> /etc/profile'
sudo sh -c 'echo "export PATH=${MAVEN_HOME}/bin:$PATH" >> /etc/profile'
rm -rf ${MAVEN}-bin.tar.gz

sudo yum install -y atlas-devel           

echo "Get expected CMake"
export cmake_version=3.16.4
export cmake_name=cmake-${cmake_version}-Linux-x86_64
wget https://github.com/Kitware/CMake/releases/download/v${cmake_version}/${cmake_name}.tar.gz
tar -zxf ${cmake_name}.tar.gz
rm -rf ${cmake_name}.tar.gz
#cd ${cmake_name}
#./bootstrap
#make && sudo make install
#cd ..
sudo cp -r ${cmake_name}/* /usr/local/
rm -rf ${cmake_name}

# Setup Jenkins
sudo mkdir -p /var/lib/jenkins/workspace
sudo chown -R centos:centos /var/lib/jenkins
sudo ln -s /var/lib/jenkins /jenkins

echo "Install AWS Cli"
sudo pip3 install awscli --upgrade

echo "Import gpg key"
aws s3 cp s3://@S3_BUCKET@/HPCCSystems.priv .
gpg --batch --yes --passphrase @GPG_PASSPHRASE@  --import HPCCSystems.priv
rm -rf HPCCSystems.priv
